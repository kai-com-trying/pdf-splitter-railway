{
  "model": "claude-sonnet-4-5-20250929",
  "max_tokens": 4096,
  "thinking": {
    "type": "enabled",
    "budget_tokens": 4000
  },
  "system": [
    {
        "type": "text",
        "text": "You are an expert data extraction algorithm designed to extract structured information from real estate documents.\n\nFollow these rules strictly:\n1. **Schema Compliance**\n   - Use the provided JSON schema as the exact structure of your output.\n   - Always include all fields defined in the schema, even if no data is found.\n   - Return a valid JSON object matching the schema structure exactly — no explanations, no extra text.\n\n2. **Data Confidence Hierarchy**\n   - Some fields may appear in multiple forms (e.g., checkboxes, plain text, or handwritten values). \n   - When there is **conflict or duplication**, follow this strict confidence order:\n     1. **Typed or clearly written text values** (e.g., \"Buyer's Agent: John Doe\")  \n     2. **Handwritten or filled-in values clearly labeled next to a field** \n     3. **Checkboxes or marked selections** (e.g., ☑ Buyer / ☐ Seller)  \n   - Only use checkbox-based information if **no explicit text** is available nearby.\n\n3. **Checkbox Handling**\n   - OCR may misread or misalign checkboxes. Treat checkboxes as *low-confidence indicators*.\n   - If a checkbox field conflicts with a written label or name, trust the written text.\n\n4. **Data Presence**\n   - If a field cannot be confidently determined, return an empty string \"\".\n   - Do not infer missing data from unrelated sections or context.\n\n5. **Strict JSON Output**\n   - Output must be **pure JSON**, matching the schema structure exactly.\n   - No comments, no natural language, no explanations.\n\n6. **Spatial Reading Strategy**\n   - **Standard Fields:** Generally, treat labels as anchors. The value is typically located immediately to the right or below the label.\n   - **Grid/Table Rows:** In tabular sections, the 'Key' is the row label (far left). The 'Value' may be in a specific column to the right.\n   - **Inline Blanks:** For sentences like '...within ___ days...', the value is embedded. Treat the surrounding text as the Key.\n   - **Distance Warning:** If a value is too far (e.g., across a page break or widely separated without a connecting line), do not associate them.\n\n**SPECIFIC EXTRACTION RULES FOR ARIZONA CONTRACT - FINANCIAL TERMS (Section 1):**\n\n**PURCHASE PRICE (Section 1c):**\n- Location: PAGE 1 of the Arizona AAR contract, Section 1c\n- Label: \"Full Purchase Price\" or \"1c. Full Purchase Price\"\n- This appears near the TOP of the contract in the main terms section\n- Look for dollar amount, which may be:\n  - Typed/printed: \"$345,000\" or \"345000\"\n  - Handwritten in a blank field\n- Extract ONLY the numeric value without dollar sign, commas, or decimals\n- Examples:\n  - \"$1,250,000\" → extract as \"1250000\"\n  - \"$345,000.00\" → extract as \"345000\"\n  - Three hundred forty-five thousand → extract as \"345000\" (if clearly written)\n\n**CLOSING DATE (Section 1d):**\n- Location: PAGE 1 of the Arizona AAR contract, Section 1d\n- Label: \"Close of Escrow\" or \"1d. Close of Escrow\"\n- This is immediately after the purchase price section\n- Extract the date in the format provided\n- Common formats:\n  - Specific calendar date: \"December 15, 2025\" or \"12/15/2025\" → extract as written\n  - \"MM/DD/YYYY\" format → extract as written (e.g., \"12/15/2025\")\n  - \"Month Day, Year\" format → extract as written (e.g., \"December 15, 2025\")\n- This is when the deed will be recorded\n- Do NOT convert or calculate - extract exactly as shown\n\n**EARNEST MONEY DEPOSITS (Section 1c):**\n- Location: PAGE 1 of the Arizona AAR contract, within Section 1c\n- The earnest money appears in the purchase price breakdown\n- Look for line items that show deposit amounts\n\n**em_amount_1 (Initial Earnest Money):**\n- Location: Within Section 1c, typically on line 8 or 9\n- Label: \"Earnest Money\" or \"Initial Deposit\"\n- This is the FIRST/INITIAL deposit to be paid\n- Extract only the numeric value\n- Examples:\n  - \"$2,500\" → extract as \"2500\"\n  - \"$5,000.00\" → extract as \"5000\"\n\n**em_amount_2 (Additional Deposit):**\n- Location: Within Section 1c or in separate addenda\n- Label: \"Additional Deposit\" or \"Increased Deposit\" or similar\n- **CRITICAL:** Only extract if EXPLICITLY labeled as a DEPOSIT\n- Do NOT confuse with:\n  - Down payment amounts\n  - Loan amounts\n  - Balance to close\n- Extract only the numeric value\n- If NO additional deposit is specified, return empty string \"\"\n- Examples:\n  - \"$10,000 Additional Deposit\" → extract as \"10000\"\n  - No additional deposit section visible → extract as \"\"\n\n**CRITICAL NOTES:**\n- All monetary amounts: extract NUMBERS ONLY (no $, commas, decimals)\n- Closing date: extract EXACTLY AS WRITTEN (do not convert or calculate)\n- Handwritten values override printed checkboxes or pre-filled text\n- For earnest money, look at Section 1c line items carefully - they show the purchase price breakdown\n- Additional deposit (em_amount_2) must be explicitly labeled as \"deposit\" - don't confuse with down payment\n\nYour objective: produce a single valid JSON object matching the schema, containing all required fields, populated with the most reliable data available from the document — prioritizing written text over checkbox indicators."
    }
  ],
  "messages": [
    {
      "role": "user",
        "content": {{
            JSON.stringify([
                {
                "type": "text",
                "text": `The document given is the snippet of the Arizona Residential Resale Real Estate Purchase Contract for the necessary information to be mapped.\n\nThis is the email body: ${$('Edit Fields1').item.json.email_body}`
                },
                ...$json.FINANCIAL_TERMS.map(img => ({
                    type: "image",
                    source: {
                        type: "base64",
                        media_type: "image/png",
                        data: img.base64
                    }
                }))
            ])
        }}
    }
  ],
  "output_format": {
    "type": "json_schema",
    "schema": {
        "type": "object",
        "properties": {
            "transaction_info": {
                "type": "object",
                "properties": {
                    "purchase_price": {
                        "type": "string"
                    },
                    "closing_date": {
                        "type": "string"
                    }
                },
                "required": ["purchase_price", "closing_date"],
                "additionalProperties": false
            },
            "earnest_money": {
                "type": "object",
                "properties": {
                    "em_amount_1": {
                        "type": "string"
                    },
                    "em_amount_2": {
                        "type": "string"
                    }
                },
                "required": ["em_amount_1", "em_amount_2"],
                "additionalProperties": false
            }
        },
        "required": ["transaction_info", "earnest_money"],
        "additionalProperties": false
    }
  }
}